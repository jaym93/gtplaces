Index: configure.in
===================================================================
RCS file: /repository/php-src/configure.in,v
retrieving revision 1.579.2.52.2.77.2.51
diff -u -u -r1.579.2.52.2.77.2.51 configure.in
--- php-5.3.0/configure.in        6 May 2009 18:57:45 -0000       
1.579.2.52.2.77.2.51
+++ php-5.3.0/configure.in        18 May 2009 18:21:14 -0000
@@ -464,7 +464,8 @@
 sys/utsname.h \
 sys/ipc.h \
 dlfcn.h \
-assert.h
+assert.h \
+crt_externs.h
 ],[],[],[
 #ifdef HAVE_SYS_PARAM_H
 #include <sys/param.h>
Index: ext/spl/spl_dllist.h
===================================================================
RCS file: /repository/php-src/ext/spl/spl_dllist.h,v
retrieving revision 1.1.2.4
diff -u -u -r1.1.2.4 spl_dllist.h
--- php-5.3.0/ext/spl/spl_dllist.h        31 Dec 2008 11:15:43 -0000      
1.1.2.4
+++ php-5.3.0/ext/spl/spl_dllist.h        18 May 2009 18:21:15 -0000
@@ -24,9 +24,9 @@
 #include "php.h"
 #include "php_spl.h"
 
-PHPAPI zend_class_entry *spl_ce_SplDoublyLinkedList;
-PHPAPI zend_class_entry *spl_ce_SplQueue;
-PHPAPI zend_class_entry *spl_ce_SplStack;
+extern PHPAPI zend_class_entry *spl_ce_SplDoublyLinkedList;
+extern PHPAPI zend_class_entry *spl_ce_SplQueue;
+extern PHPAPI zend_class_entry *spl_ce_SplStack;
 
 PHP_MINIT_FUNCTION(spl_dllist);
 
Index: ext/spl/spl_fixedarray.h
===================================================================
RCS file: /repository/php-src/ext/spl/spl_fixedarray.h,v
retrieving revision 1.1.2.3
diff -u -u -r1.1.2.3 spl_fixedarray.h
--- php-5.3.0/ext/spl/spl_fixedarray.h    31 Dec 2008 11:15:43 -0000      
1.1.2.3
+++ php-5.3.0/ext/spl/spl_fixedarray.h    18 May 2009 18:21:15 -0000
@@ -22,7 +22,7 @@
 #ifndef SPL_FIXEDARRAY_H
 #define SPL_FIXEDARRAY_H
 
-PHPAPI zend_class_entry *spl_ce_SplFixedArray;
+extern PHPAPI zend_class_entry *spl_ce_SplFixedArray;
 
 PHP_MINIT_FUNCTION(spl_fixedarray);
 
Index: ext/spl/spl_heap.h
===================================================================
RCS file: /repository/php-src/ext/spl/spl_heap.h,v
retrieving revision 1.1.2.3
diff -u -u -r1.1.2.3 spl_heap.h
--- php-5.3.0/ext/spl/spl_heap.h  31 Dec 2008 11:15:44 -0000      1.1.2.3
+++ php-5.3.0/ext/spl/spl_heap.h  18 May 2009 18:21:15 -0000
@@ -24,11 +24,11 @@
 #include "php.h"
 #include "php_spl.h"
 
-PHPAPI zend_class_entry *spl_ce_SplHeap;
-PHPAPI zend_class_entry *spl_ce_SplMinHeap;
-PHPAPI zend_class_entry *spl_ce_SplMaxHeap;
+extern PHPAPI zend_class_entry *spl_ce_SplHeap;
+extern PHPAPI zend_class_entry *spl_ce_SplMinHeap;
+extern PHPAPI zend_class_entry *spl_ce_SplMaxHeap;
 
-PHPAPI zend_class_entry *spl_ce_SplPriorityQueue;
+extern PHPAPI zend_class_entry *spl_ce_SplPriorityQueue;
 
 PHP_MINIT_FUNCTION(spl_heap);
 
--- php-5.3.0/main/php.h	2009-06-26 18:44:19.000000000 +0300
+++ php-5.3.0/main/php.h	2009-11-04 13:46:31.737518000 +0200
@@ -258,13 +258,19 @@
 # endif
 #endif
 
-
 /* global variables */
-#if !defined(PHP_WIN32)
-#define PHP_SLEEP_NON_VOID
-#define php_sleep sleep
-extern char **environ;
-#endif	/* !defined(PHP_WIN32) */
+  #if !defined(PHP_WIN32)
+  #define PHP_SLEEP_NON_VOID
+  #define php_sleep sleep
+ 
+ #if HAVE_CRT_EXTERNS_H
+ #include <crt_externs.h>
+ #define environ (*_NSGetEnviron())
+ #else
+  extern char **environ;
+ #endif
+ #endif /* !defined(PHP_WIN32) */
+
 
 #ifdef PHP_PWRITE_64
 ssize_t pwrite(int, void *, size_t, off64_t);
--- php-5.3.0/sapi/cli/config.m4	2008-09-01 16:15:31.000000000 +0300
+++ php-5.3.0/sapi/cli/config.m4	2009-11-04 13:46:31.764517000 +0200
@@ -20,9 +20,6 @@
       BUILD_CLI="echo '\#! .' > php.sym && echo >>php.sym && nm -BCpg \`echo \$(PHP_GLOBAL_OBJS) \$(PHP_CLI_OBJS) | sed 's/\([A-Za-z0-9_]*\)\.lo/\1.o/g'\` | \$(AWK) '{ if (((\$\$2 == \"T\") || (\$\$2 == \"D\") || (\$\$2 == \"B\")) && (substr(\$\$3,1,1) != \".\")) { print \$\$3 } }' | sort -u >> php.sym && \$(LIBTOOL) --mode=link \$(CC) -export-dynamic \$(CFLAGS_CLEAN) \$(EXTRA_CFLAGS) \$(EXTRA_LDFLAGS_PROGRAM) \$(LDFLAGS) -Wl,-brtl -Wl,-bE:php.sym \$(PHP_RPATHS) \$(PHP_GLOBAL_OBJS) \$(PHP_CLI_OBJS) \$(EXTRA_LIBS) \$(ZEND_EXTRA_LIBS) -o \$(SAPI_CLI_PATH)"
     fi
     ;;
-  *darwin*)
-    BUILD_CLI="\$(CC) \$(CFLAGS_CLEAN) \$(EXTRA_CFLAGS) \$(EXTRA_LDFLAGS_PROGRAM) \$(LDFLAGS) \$(NATIVE_RPATHS) \$(PHP_GLOBAL_OBJS:.lo=.o) \$(PHP_CLI_OBJS:.lo=.o) \$(PHP_FRAMEWORKS) \$(EXTRA_LIBS) \$(ZEND_EXTRA_LIBS) -o \$(SAPI_CLI_PATH)"
-    ;;
   *netware*)
     BUILD_CLI="\$(LIBTOOL) --mode=link \$(CC) -export-dynamic \$(CFLAGS_CLEAN) \$(EXTRA_CFLAGS) \$(EXTRA_LDFLAGS_PROGRAM) \$(LDFLAGS) \$(PHP_RPATHS) \$(PHP_CLI_OBJS) \$(EXTRA_LIBS) \$(ZEND_EXTRA_LIBS) -Lnetware -lphp5lib -o \$(SAPI_CLI_PATH)"
     ;;
--- php-5.3.0/main/php_getopt.h	2008-12-31 13:15:47.000000000 +0200
+++ php-5.3.0/main/php_getopt.h	2009-11-04 13:46:31.752516000 +0200
@@ -41,7 +41,7 @@
 
 BEGIN_EXTERN_C()
 /* holds the index of the latest fetched element from the opts array */
-PHPAPI int php_optidx;
+extern PHPAPI int php_optidx;
 PHPAPI int php_getopt(int argc, char* const *argv, const opt_struct opts[], char **optarg, int *optind, int show_err, int arg_start);
 END_EXTERN_C()
 
